<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Details - PytestArch</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
        <link href="../assets/_mkdocstrings.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Details";
        var mkdocs_page_input_path = "details.md";
        var mkdocs_page_url = null;
      </script>
    
    <script src="../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> PytestArch
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Welcome to PytestArch</a>
                </li>
              </ul>
              <ul class="current">
                <li class="toctree-l1 current"><a class="reference internal current" href="./">Details</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#general-concept">General Concept</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#simple-example">Simple Example</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#parsing-all-files">Parsing all files</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#excluding-some-files">Excluding some files</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#more-complex-example">More complex example</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#query-language">Query Language</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#general-structure">General Structure</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#features">Features</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#rule_subject">RULE_SUBJECT</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#rule_object">RULE_OBJECT</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#verb_marker_1">VERB_MARKER_1</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#import_type-verb_marker_2">IMPORT_TYPE + VERB_MARKER_2</a>
    </li>
        </ul>
    </li>
        </ul>
    </li>
    </ul>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../changelog/">Changelog</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Reference</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../general/">General</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../eval_structure/">Evaluation</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../parsing/">Parsing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../query_language/">Query Language</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">PytestArch</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" alt="Docs"></a> &raquo;</li>
      <li>Details</li>
    <li class="wy-breadcrumbs-aside">
        <a href="https://github.com/zyskarch/pytestarch/edit/master/docs/details.md"
          class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="details">Details</h1>
<h2 id="general-concept">General Concept</h2>
<p>PytestArch creates an Abstract Syntax Tree for each Python file it scans. It then extracts only the information about 
module imports from the AST and converts them to an internal representation. This is currently a graph supplied by the 
<a href="https://networkx.org/">NetworkX</a> library.</p>
<p>When the user defines a rule and evaluates the internal representation against it, the rule is converted into a set of
graph operations that are then carried out on the previously generated graph.</p>
<h2 id="simple-example">Simple Example</h2>
<h3 id="parsing-all-files">Parsing all files</h3>
<p>Consider the following project structure:</p>
<pre><code>my_project/
    src/
        main.py
        util.py
        util_test.py
</code></pre>
<p>Both <code>main.py</code> and <code>util_test.py</code> are importing a util function defined in <code>util.py</code>; no other imports exist.</p>
<p>With "my_project" as the project's root folder and "src" as the folder to evaluate, this will create the following graph:</p>
<p><img alt="Simple Example Graph" src="../resources/docu_simple_example.png" /></p>
<p>Each module has a direct path to all submodules, in this case: "src" is connected to all three modules it contains, 
"src.main", "src.util", and "src.util_test".</p>
<p>In addition, a module that imports another module has an directed edge linking it to this module. For example, "src.main"
imports "src.util" and therefore the graph has an edge connecting these modules, with the arrow head pointing at the imported
module, in this case "src.util".</p>
<h3 id="excluding-some-files">Excluding some files</h3>
<p>In the example above, the <code>util_test.py</code> file is included in the graph and will be considered when evaluating the architecture.
If certain files should be excluded from the analysis, this can be done by specifying an exclusion pattern. In our example,
if we want to exclude <code>util_test.py</code>, we could use:</p>
<pre><code>from pytestarch.pytestarch import get_evaluable

evaluable = get_evaluable(&quot;/home/my_project&quot;, &quot;/home/my_project/src&quot;, (&quot;*_test.py&quot;))
</code></pre>
<p>This will exclude all files with names ending in "_test.py". It is also possible to exclude directories.</p>
<h2 id="more-complex-example">More complex example</h2>
<p>As a basis for describing the query language, let's consider a more complex example:</p>
<pre><code>/test_project
    /src
       __init__.py
       /A
            __init__.py
            fileA.py
            /A1
                __init__.py
                fileA1.py
                fileA1_b.py
                /A11
                    __init__.py
                    fileA11.py
            /A2
                __init__.py
                fileA2.py
       /B
            __init__.py
            fileB.py
            /B1
                __init__.py
                fileB1.py
                fileB2.py
       /C 
            __init__.py
            fileC.py
</code></pre>
<p>With the following list of imports:</p>
<ul>
    <li>fileA imports fileC</li>
    <li>fileA11 imports fileB1</li>
    <li>fileA2 imports fileC</li>
    <li>fileB imports fileA11</li>
    <li>fileB2 imports fileA11</li>
    <li>fileC imports the built-in os module</li>
</ul>

<p>This creates the following graph (excluding all <code>__init__.py</code>):</p>
<p><img alt="Complex Example" src="../resources/docu_complex_example.png" /></p>
<p>Note that the module names in the diagram have been abbreviated: For example, the node "fileA" is actually named "src.A.fileA".</p>
<p>Most of the edges in this graph are due to parent-child relationships between the modules. However, five of the six import
relationships defined above are present in the graph - only fileC has no connection to an "os" node; in fact, there is no
node names "os" at all.</p>
<p>This has been achieved by setting the <code>exclude_external_libraries</code> flag in the <code>get_evaluable</code> function. All modules that 
not located hierarchically below the root path, in this case "test_project", will be excluded from the graph.</p>
<h2 id="query-language">Query Language</h2>
<h3 id="general-structure">General Structure</h3>
<p>The query language that can be used to define architectural rules follows this structure: </p>
<p>RULE_SUBJECT - VERB_MARKER_1 - IMPORT_TYPE - VERB_MARKER_2 - RULE_OBJECT</p>
<p>The meaning of these structural markers is described in the table below.</p>
<table>
<thead>
<tr>
<th>Marker</th>
<th>Description</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td>RULE_SUBJECT</td>
<td>module(s) to be checked</td>
<td>modules that are named 'B'</td>
</tr>
<tr>
<td>RULE_OBJECT</td>
<td>module(s) to check against</td>
<td>modules that are submodules of 'A'</td>
</tr>
<tr>
<td>IMPORT_TYPE</td>
<td>expected type of import relationship</td>
<td>be imported by</td>
</tr>
<tr>
<td>VERB_MARKER_1</td>
<td>defines the expected behavior, part I</td>
<td>should not</td>
</tr>
<tr>
<td>VERB_MARKER_2</td>
<td>defines the expected behavior, part II</td>
<td>except</td>
</tr>
</tbody>
</table>
<p>The examples given in the table above combined form the rule <code>modules that are named 'B' (RULE_SUBJECT) should not (VERB_MARKER_1) be imported by (IMPORT_TYPE) modules except (VERB_MARKER_2) modules that are submodules of "A" (RULE_OBJECT)</code>.</p>
<p>Looking at the diagram in the section Complex Example, we can see that this rule holds - the only module importing 
from the "B" module is "fileA11", which is a submodule of "A".</p>
<h3 id="features">Features</h3>
<p>Currently, the following markers are supported by PytestArch:</p>
<h4 id="rule_subject">RULE_SUBJECT</h4>
<ul>
<li>are_named("X"): applies to module named "X"</li>
<li>are_submodules_of("Y"): applies to submodules of module named "Y"</li>
</ul>
<h4 id="rule_object">RULE_OBJECT</h4>
<p>same as RULE_SUBJECT</p>
<h4 id="verb_marker_1">VERB_MARKER_1</h4>
<ul>
<li>should()</li>
<li>should_only()</li>
<li>should_not()</li>
</ul>
<h4 id="import_type-verb_marker_2">IMPORT_TYPE + VERB_MARKER_2</h4>
<ul>
<li>import_modules_that()</li>
<li>import_modules_except_modules_that()</li>
<li>be_imported_by_modules_that()</li>
<li>be_imported_by_modules_except_modules_that()</li>
</ul>
<p>VERB_MARKER_2 and IMPORT_TYPE have been conflated into one expression to improve readability.</p>
<p>Markers from each category can be combined freely with all markers of all other categories. Example rules could be <br>
<code>modules_that()
    .are_sub_modules_of("A")
    .should_only()
    .be_imported_by_modules_that()
    .are_sub_modules_of("B")</code> (True in the above example).</p>
<p>or <br>
<code>modules_that()
    .are_named("C")
    .should_only()
    .be_imported_by_modules_that()
    .are_named("A2")</code> (False, also imported by module "A").</p>
<p>Most rules are so close to the English language that a detailed explanation seems unnecessary. An exception might be the
VERB_MARKER_2 "except". A combination of this VERB_MARKER_2 and every type of VERB_MARKER_1 and IMPORT_TYPE is given below
as reference (M1, M2 are used as RULE_SUBJECT and RULE_OBJECT respectively; pseudo code for brevity):</p>
<table>
<thead>
<tr>
<th>Rule</th>
<th>Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td>M1 should import except M2</td>
<td>M1 should import at least one module that isn't M2, but can also import M2</td>
</tr>
<tr>
<td>M1 should only import except M2</td>
<td>M1 should import at least one module that isn't M2 and should not import M2</td>
</tr>
<tr>
<td>M1 should not import except M2</td>
<td>M1 should not import any module other than M2, but does not have to import M2</td>
</tr>
<tr>
<td>M1 should be imported except by M2</td>
<td>at least one module that isn't M2 should import M1 (M2 can import M1 as well)</td>
</tr>
<tr>
<td>M1 should only be imported except by M2</td>
<td>at least one module that isn't M2 should import M1, and M2 cannot import M1</td>
</tr>
<tr>
<td>M1 should not be imported except by M2</td>
<td>no module other than M2 should import M1, but M2 does not have to import M1</td>
</tr>
</tbody>
</table>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href=".." class="btn btn-neutral float-left" title="Welcome to PytestArch"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../changelog/" class="btn btn-neutral float-right" title="Changelog">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/zyskarch/pytestarch" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
      <span><a href=".." style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../changelog/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme_extra.js" defer></script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
